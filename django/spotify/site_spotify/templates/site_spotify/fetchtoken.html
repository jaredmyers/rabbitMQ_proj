<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <title>Dashboard</title>
    </head>
        <body>
           {{ code|json_script:"code" }}
            
            <script>
                const TOKEN = "https://accounts.spotify.com/api/token";
                var client_id = '4ed36c33643a4974817619f60d7615cd';
                var client_secret = '7db6c1bc9d2f4a328f0968700b95fc69';
                var redirect_uri = 'http://localhost:8000/site_spotify/urlredirect';
                var authorize = 'https://accounts.spotify.com/api/token';
                var scope = 'user-library-read';
                
                function fetchAccessToken( code ){
                    let body = "grant_type=authorization_code";
                    body += "&code=" + code; 
                    body += "&redirect_uri=" + encodeURI(redirect_uri);
                    body += "&client_id=" + client_id;
                    body += "&client_secret=" + client_secret;
                    callAuthorizationApi(body);

                }
                function callAuthorizationApi(body){
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", TOKEN, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa(client_id + ":" + client_secret));
                    xhr.send(body);
                    xhr.onload = handleAuthorizationResponse;

                }
                function handleAuthorizationResponse(){
                    if ( this.status == 200 ){
                        var data = JSON.parse(this.responseText);
                        console.log(data);
                        var data = JSON.parse(this.responseText);
                        if ( data.access_token != undefined ){
                            access_token = data.access_token;
                            localStorage.setItem("access_token", access_token);
                        }
                        if ( data.refresh_token  != undefined ){
                            refresh_token = data.refresh_token;
                            localStorage.setItem("refresh_token", refresh_token);
                        }
                        //onPageLoad();
                    }
                    else {
                        console.log(this.responseText);
                        alert(this.responseText);
                    
                    
                    }
                }
                
                const code = JSON.parse(document.getElementById("code").textContent);
                
                fetchAccessToken( code );
         
            </script>
           {{ code }}
        </body>
</html>