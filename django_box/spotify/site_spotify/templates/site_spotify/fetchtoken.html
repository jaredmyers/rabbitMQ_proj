<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- JavaScript Bundle with Popper -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <title>Fetching token..</title>
    </head>
        <body>
           {{ code|json_script:"code" }}
           {% csrf_token %}

            <script>
                const TOKEN = "https://accounts.spotify.com/api/token";
                var client_id = '';
                var client_secret = '';
                var redirect_uri = 'http://192.168.1.3/site_spotify/urlredirect';
                var authorize = 'https://accounts.spotify.com/api/token';
                var scope = 'user-library-read';
                var toke;
                
                function fetchAccessToken( code ){
                    let body = "grant_type=authorization_code";
                    body += "&code=" + code; 
                    body += "&redirect_uri=" + encodeURI(redirect_uri);
                    body += "&client_id=" + client_id;
                    body += "&client_secret=" + client_secret;
                    callAuthorizationApi(body);

                }
                function callAuthorizationApi(body){
                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", TOKEN, true);
                    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                    xhr.setRequestHeader('Authorization', 'Basic ' + btoa(client_id + ":" + client_secret));
                    xhr.send(body);
                    xhr.onload = handleAuthorizationResponse;

                }
                
                function handleAuthorizationResponse(){
                    if ( this.status == 200 ){
                        var data = JSON.parse(this.responseText);
                        console.log(data);
                        var data = JSON.parse(this.responseText);
                        if ( data.access_token != undefined ){
                            access_token = data.access_token;
                            sessionStorage.setItem("access_token", access_token);
                            
                            console.log("Token is: "+access_token)
                        }
                        if ( data.refresh_token  != undefined ){
                            refresh_token = data.refresh_token;
                            sessionStorage.setItem("refresh_token", refresh_token);
                        }
                        //onPageLoad();
                        console.log('sending token to dashboard')
                        sendTokenData(access_token)
                    }
                    else {
                        console.log(this.responseText);
                        alert(this.responseText);
                    
                    
                    }
                }

                function sendTokenData(token_data){
                    
                    $.ajax({
                        type: "POST",
                        url: '/site_spotify/dashboard',
                        data: {
                            "csrfmiddlewaretoken": $("input[name=csrfmiddlewaretoken]").val(),
                            "token": token_data,
                        },
                        dataType: "json",
                        


                    });
                    //window.location.href = '/site_spotify/dashboard'
                    
                    

                    
                    
                    /*
                    url = "{% url 'site_spotify:home' %}";
                    data = {
                        "csrfmiddlewaretoken": $("input[name=csrfmiddlewaretoken]").val(),
                        "token": token_data}
                    $.post(url, token_data, function(response){
                        if(resposne === 'success'){console.log("It worked");}
                        else{console.log("it failed");}
                    });
                    */

                }
                
                const code = JSON.parse(document.getElementById("code").textContent);
                
                fetchAccessToken( code );

                //var token = sessionStorage.access_token;
                //alert(token)

                //sendTokenData(token);


            </script>
            <h3 class="h3 mb-3 fw-normal center"><a href='home'>Success! Click here to view Dashboard!</a></h3>

        </body>
</html>